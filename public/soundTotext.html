<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Web Speech å®æ—¶è¯­éŸ³è½¬æ–‡å­—ï¼ˆEdge/Chromeï¼‰</title>
  <style>
    :root {
      --bg: #0f172a; /* slate-900 */
      --panel: #111827cc; /* gray-900 with alpha */
      --text: #e5e7eb; /* gray-200 */
      --muted: #9ca3af; /* gray-400 */
      --accent: #60a5fa; /* blue-400 */
      --accent-2: #34d399; /* emerald-400 */
      --danger: #f87171; /* red-400 */
      --warn: #fbbf24; /* amber-400 */
      --radius: 16px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; background: radial-gradient(1200px 800px at 20% 0%, #0b1228, var(--bg));
      color: var(--text); font: 16px/1.6 system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans CJK SC", Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      display: grid; place-items: center;
      padding: 24px;
    }
    .app {
      width: min(1100px, 100%);
      background: linear-gradient(180deg, #0b1228, #0b122880);
      border: 1px solid #1f2937; border-radius: var(--radius);
      box-shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);
      overflow: hidden;
    }
    header { display: flex; align-items: center; justify-content: space-between; padding: 18px 22px; border-bottom: 1px solid #1f2937; }
    header h1 { font-size: 18px; margin: 0; letter-spacing: .2px; }
    header .ua { font-size: 12px; color: var(--muted); }

    .controls { display: grid; grid-template-columns: repeat(12, 1fr); gap: 12px; padding: 16px 22px; background: #0b1228a6; border-bottom: 1px solid #1f2937; }
    .controls .row { display: contents; }

    .group { grid-column: span 3; display: flex; flex-direction: column; gap: 8px; min-width: 0; }
    .group label { font-size: 12px; color: var(--muted); }
    select, input[type="text"] {
      width: 100%; padding: 10px 12px; border-radius: 12px; border: 1px solid #293241; background: #0b1228; color: var(--text);
      outline: none; transition: border .15s ease;
    }
    select:focus, input[type="text"]:focus { border-color: var(--accent); }

    .btnbar { grid-column: 1 / -1; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    button {
      appearance: none; border: 1px solid #1f2937; background: #0b1228; color: var(--text);
      padding: 10px 14px; border-radius: 999px; cursor: pointer;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.05); transition: transform .05s ease, border-color .2s, background .2s;
    }
    button:hover { border-color: #334155; }
    button:active { transform: translateY(1px); }
    .primary { background: linear-gradient(180deg, #1e3a8a, #1f2937); border-color: #1e3a8a; }
    .success { border-color: #065f46; background: linear-gradient(180deg, #065f46, #1f2937); }
    .danger { border-color: #7f1d1d; background: linear-gradient(180deg, #7f1d1d, #1f2937); }
    .ghost { background: transparent; }
    .pill { padding: 7px 12px; font-size: 12px; color: var(--muted); border-radius: 999px; border: 1px dashed #374151; }

    .statusbar { display: flex; align-items: center; gap: 10px; font-size: 13px; color: var(--muted); }
    .dot { width: 10px; height: 10px; border-radius: 50%; background: #475569; box-shadow: 0 0 0 3px rgba(71,85,105,.25) inset; }
    .dot.live { background: var(--accent-2); box-shadow: 0 0 0 6px rgba(52, 211, 153, .15); }
    .dot.err { background: var(--danger); box-shadow: 0 0 0 6px rgba(248, 113, 113, .15); }

    main { display: grid; grid-template-columns: 1fr 320px; gap: 0; }
    .transcript { padding: 18px 22px; min-height: 380px; }
    .transcript .final { white-space: pre-wrap; word-break: break-word; font-size: 16px; }
    .transcript .interim { opacity: .6; font-style: italic; }
    .side { border-left: 1px solid #1f2937; padding: 18px 16px; background: #0b122850; display: flex; flex-direction: column; gap: 12px; }
    .side h3 { margin: 2px 0 0; font-size: 14px; color: var(--muted); font-weight: 600; }
    .kv { font-size: 13px; display: grid; grid-template-columns: 110px 1fr; gap: 6px 8px; }
    .kv div { color: var(--muted); }
    .kv b { color: var(--text); font-weight: 600; }

    .footer { display: flex; gap: 10px; align-items: center; justify-content: space-between; padding: 12px 22px; border-top: 1px solid #1f2937; background: #0b1228a6; }
    .error { color: var(--danger); font-size: 13px; }
    .tips { color: var(--muted); font-size: 12px; }

    @media (max-width: 900px) {
      main { grid-template-columns: 1fr; }
      .side { border-left: none; border-top: 1px solid #1f2937; }
      .group { grid-column: span 6; }
    }
    @media (max-width: 600px) {
      .group { grid-column: span 12; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>ğŸ™ï¸ Web Speech è¯­éŸ³è¾“å…¥ â†’ å®æ—¶è½¬æ–‡å­—</h1>
      <div class="ua" id="ua"></div>
    </header>

    <section class="controls">
      <div class="group">
        <label for="lang">è¯†åˆ«è¯­è¨€</label>
        <select id="lang">
          <option value="zh-CN">ä¸­æ–‡ï¼ˆæ™®é€šè¯ï¼‰- zh-CN</option>
          <option value="en-US">English (US) - en-US</option>
          <option value="ja-JP">æ—¥æœ¬èª - ja-JP</option>
          <option value="ko-KR">í•œêµ­ì–´ - ko-KR</option>
          <option value="de-DE">Deutsch - de-DE</option>
          <option value="fr-FR">FranÃ§ais - fr-FR</option>
          <option value="es-ES">EspaÃ±ol - es-ES</option>
          <option value="it-IT">Italiano - it-IT</option>
          <option value="ru-RU">Ğ ÑƒÑÑĞºĞ¸Ğ¹ - ru-RU</option>
        </select>
      </div>

      <div class="group">
        <label>æ¨¡å¼</label>
        <div class="btnbar">
          <label class="pill"><input type="checkbox" id="continuous" checked> è¿ç»­è¯†åˆ«</label>
          <label class="pill"><input type="checkbox" id="interim" checked> æ˜¾ç¤ºä¸­é—´ç»“æœ</label>
          <label class="pill"><input type="checkbox" id="autorestart" checked> è‡ªåŠ¨é‡è¿</label>
        </div>
      </div>

      <div class="group">
        <label>åˆ†æ®µå…³é”®å­—ï¼ˆå¯é€‰ï¼Œé‡åˆ°åˆ™æ¢è¡Œï¼‰</label>
        <input type="text" id="breakWords" placeholder="ä¾‹å¦‚ï¼šå¥å·ã€‚period, é€—å·, ã‚«ãƒ³ãƒ" />
      </div>

      <div class="btnbar">
        <button id="btnStart" class="primary">å¼€å§‹</button>
        <button id="btnPause">æš‚åœ</button>
        <button id="btnStop" class="danger">åœæ­¢å¹¶æ¸…éº¦</button>
        <button id="btnCopy" class="ghost">å¤åˆ¶æ–‡æœ¬</button>
        <button id="btnSave" class="ghost">å¯¼å‡º .txt</button>
        <span class="statusbar">
          <span id="dot" class="dot" title="çŠ¶æ€æŒ‡ç¤º"></span>
          <span id="status">ç©ºé—²</span>
        </span>
      </div>
    </section>

    <main>
      <div class="transcript">
        <div id="final" class="final"></div>
        <div id="interim" class="interim"></div>
      </div>
      <aside class="side">
        <h3>è¿è¡Œä¿¡æ¯</h3>
        <div class="kv">
          <div>å¼•æ“</div><b id="engine">â€”</b>
          <div>æ˜¯å¦æ”¯æŒ</div><b id="supported">â€”</b>
          <div>è¿ç»­è¯†åˆ«</div><b id="kvContinuous">â€”</b>
          <div>ä¸­é—´ç»“æœ</div><b id="kvInterim">â€”</b>
          <div>è¯­è¨€</div><b id="kvLang">â€”</b>
          <div>ä¸Šæ¬¡é”™è¯¯</div><b id="lastErr">â€”</b>
        </div>
        <h3>æç¤º</h3>
        <ul class="tips">
          <li>Chrome ä¼šä½¿ç”¨ Google è¯†åˆ«ï¼›Edge ä¼šä½¿ç”¨ Microsoft è¯†åˆ«ï¼ˆä¸¤è€…å‡èµ° Web Speech APIï¼‰ã€‚</li>
          <li>åˆæ¬¡ä½¿ç”¨ä¼šå¼¹å‡ºéº¦å…‹é£æƒé™æç¤ºï¼›å¿…é¡»å…è®¸æ‰èƒ½è¯†åˆ«ã€‚</li>
          <li>è‹¥é•¿æ—¶é—´æ— å£°ï¼Œéƒ¨åˆ†æµè§ˆå™¨ä¼šè‡ªåŠ¨åœæ­¢ï¼›å‹¾é€‰â€œè‡ªåŠ¨é‡è¿â€å¯è‡ªåŠ¨ç»§ç»­ã€‚</li>
          <li>æ­¤ç¤ºä¾‹åœ¨ Chrome/Edge æ¡Œé¢ç«¯æœ€ä½³ï¼›Safari/Firefox æœªåŸç”Ÿæ”¯æŒ SpeechRecognitionã€‚</li>
        </ul>
      </aside>
    </main>

    <div class="footer">
      <div class="error" id="err"></div>
      <div class="tips">å¼€æºç¤ºä¾‹ï¼Œä»…åšæ¼”ç¤ºç”¨é€”ã€‚</div>
    </div>
  </div>

  <script>
    // --- ç¯å¢ƒä¸å…¼å®¹æ€§ ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = SpeechRecognition ? new SpeechRecognition() : null;

    const els = {
      ua: document.getElementById('ua'),
      engine: document.getElementById('engine'),
      supported: document.getElementById('supported'),
      kvContinuous: document.getElementById('kvContinuous'),
      kvInterim: document.getElementById('kvInterim'),
      kvLang: document.getElementById('kvLang'),
      lastErr: document.getElementById('lastErr'),
      status: document.getElementById('status'),
      dot: document.getElementById('dot'),
      final: document.getElementById('final'),
      interim: document.getElementById('interim'),
      err: document.getElementById('err'),
      lang: document.getElementById('lang'),
      continuous: document.getElementById('continuous'),
      interimChk: document.getElementById('interim'), // note: id clash; we keep reference separately for text div
      interimFlag: document.getElementById('interim'),
      breakWords: document.getElementById('breakWords'),
      btnStart: document.getElementById('btnStart'),
      btnPause: document.getElementById('btnPause'),
      btnStop: document.getElementById('btnStop'),
      btnCopy: document.getElementById('btnCopy'),
      btnSave: document.getElementById('btnSave'),
    };
    els.ua.textContent = navigator.userAgent;

    // è§£å†³ä¸ transcript .interim çš„ ID å†²çªï¼ˆä¸Šé¢è¯¯ç”¨ï¼‰
    const interimDiv = document.querySelector('.interim');
    const interimCheckbox = document.querySelector('input#interim');

    function detectEngine() {
      const ua = navigator.userAgent.toLowerCase();
      if (ua.includes('edg/')) return 'Microsoft (Edge)';
      if (ua.includes('chrome/')) return 'Google (Chrome)';
      if (ua.includes('opera') || ua.includes('opr/')) return 'Google (Opera)';
      return 'æœªçŸ¥/å…¶ä»–';
    }

    els.engine.textContent = detectEngine();
    els.supported.textContent = recognition ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ';

    if (!recognition) {
      els.err.textContent = 'å½“å‰æµè§ˆå™¨æœªæä¾› Web Speech API çš„ SpeechRecognitionã€‚è¯·åœ¨æœ€æ–°çš„ Chrome æˆ– Edge ä¸­æ‰“å¼€æ­¤é¡µé¢ã€‚';
      // ç¦ç”¨æ§ä»¶
      for (const id of ['btnStart','btnPause','btnStop','btnCopy','btnSave']) {
        const el = document.getElementById(id); if (el) el.disabled = true;
      }
    }

    // --- é…ç½® ---
    let autoRestart = true;
    let recognizing = false;
    let finalTranscript = '';

    function refreshKV() {
      els.kvContinuous.textContent = recognition ? (recognition.continuous ? 'æ˜¯' : 'å¦') : 'â€”';
      els.kvInterim.textContent = recognition ? (recognition.interimResults ? 'æ˜¯' : 'å¦') : 'â€”';
      els.kvLang.textContent = recognition ? recognition.lang : 'â€”';
    }

    function setStatus(text, mode = 'idle') {
      els.status.textContent = text;
      els.dot.classList.remove('live','err');
      if (mode === 'live') els.dot.classList.add('live');
      if (mode === 'err') els.dot.classList.add('err');
    }

    function appendFinal(text) {
      finalTranscript += text;
      const breaks = (document.getElementById('breakWords').value || '')
        .split(/[,ï¼Œã€\s]+/).filter(Boolean);
      if (breaks.length) {
        const hit = breaks.some(w => text.includes(w));
        if (hit) finalTranscript += '\n';
      }
      els.final.textContent = finalTranscript;
    }

    function copyText() {
      const all = els.final.textContent.trim();
      if (!all) return;
      navigator.clipboard.writeText(all).then(() => {
        setStatus('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'idle');
      });
    }

    function saveText() {
      const blob = new Blob([els.final.textContent], {type: 'text/plain;charset=utf-8'});
      const a = document.createElement('a');
      const date = new Date().toISOString().replace(/[:.]/g,'-');
      a.href = URL.createObjectURL(blob);
      a.download = `speech-to-text-${date}.txt`;
      document.body.appendChild(a); a.click();
      setTimeout(() => { URL.revokeObjectURL(a.href); a.remove(); }, 0);
    }

    if (recognition) {
      // åˆå§‹è®¾ç½®
      recognition.lang = document.getElementById('lang').value;
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.maxAlternatives = 1;
      refreshKV();

      // äº‹ä»¶ç»‘å®š
      recognition.onstart = () => {
        recognizing = true;
        setStatus('æ­£åœ¨è†å¬â€¦ è¯·å¼€å§‹è¯´è¯', 'live');
        els.err.textContent = '';
      };
      recognition.onend = () => {
        recognizing = false;
        setStatus('å·²åœæ­¢');
        // è‡ªåŠ¨é‡è¿
        if (autoRestart) {
          setStatus('è¿æ¥å·²ç»“æŸï¼Œå‡†å¤‡è‡ªåŠ¨é‡è¿â€¦');
          setTimeout(() => {
            if (!recognizing) try { recognition.start(); } catch (_) {}
          }, 400);
        }
      };
      recognition.onerror = (event) => {
        const { error } = event;
        let msg = '';
        switch (error) {
          case 'no-speech': msg = 'æœªæ£€æµ‹åˆ°è¯­éŸ³ï¼ˆno-speechï¼‰ã€‚è¯·æ£€æŸ¥éº¦å…‹é£æˆ–æé«˜éŸ³é‡ã€‚'; break;
          case 'audio-capture': msg = 'æ— æ³•è®¿é—®éº¦å…‹é£ï¼ˆaudio-captureï¼‰ã€‚è¯·ç¡®è®¤è®¾å¤‡ä¸æƒé™ã€‚'; break;
          case 'not-allowed': msg = 'æƒé™è¢«æ‹’ç»ï¼ˆnot-allowedï¼‰ã€‚è¯·åœ¨åœ°å€æ å³ä¾§æ£€æŸ¥ç½‘ç«™éº¦å…‹é£æƒé™è®¾ç½®ã€‚'; break;
          case 'aborted': msg = 'è¯†åˆ«è¢«ä¸­æ­¢ï¼ˆabortedï¼‰ã€‚'; break;
          case 'network': msg = 'ç½‘ç»œé”™è¯¯ï¼ˆnetworkï¼‰ã€‚'; break;
          case 'service-not-allowed': msg = 'æœåŠ¡ä¸å¯ç”¨æˆ–è¢«ç¦ç”¨ï¼ˆservice-not-allowedï¼‰ã€‚'; break;
          default: msg = `æœªçŸ¥é”™è¯¯ï¼š${error}`;
        }
        els.err.textContent = msg;
        els.lastErr.textContent = error;
        setStatus('å‘ç”Ÿé”™è¯¯', 'err');
      };
      recognition.onresult = (event) => {
        let interimText = '';
        for (let i = event.resultIndex; i < event.results.length; ++i) {
          const result = event.results[i];
          const transcript = result[0].transcript;
          if (result.isFinal) {
            appendFinal(transcript);
          } else {
            interimText += transcript;
          }
        }
        interimDiv.textContent = interimCheckbox.checked ? interimText : '';
      };

      // æ§ä»¶äº¤äº’
      document.getElementById('lang').addEventListener('change', (e) => {
        recognition.lang = e.target.value; refreshKV();
      });
      document.getElementById('continuous').addEventListener('change', (e) => {
        recognition.continuous = e.target.checked; refreshKV();
      });
      interimCheckbox.addEventListener('change', (e) => {
        recognition.interimResults = e.target.checked; refreshKV();
      });
      document.getElementById('autorestart').addEventListener('change', (e) => {
        autoRestart = e.target.checked;
      });

      document.getElementById('btnStart').addEventListener('click', () => {
        autoRestart = document.getElementById('autorestart').checked;
        try { recognition.start(); } catch (err) { /* already started */ }
      });
      document.getElementById('btnPause').addEventListener('click', () => {
        // Web Speech API æ²¡æœ‰ pauseï¼›è¿™é‡Œé€šè¿‡ä¸´æ—¶å…³é—­è‡ªåŠ¨é‡è¿ + stop æ¨¡æ‹Ÿâ€œæš‚åœâ€
        const prev = autoRestart; autoRestart = false;
        recognition.stop();
        setTimeout(() => { autoRestart = prev; }, 100);
      });
      document.getElementById('btnStop').addEventListener('click', () => {
        autoRestart = false; recognition.stop(); setStatus('å·²åœæ­¢');
      });
      document.getElementById('btnCopy').addEventListener('click', copyText);
      document.getElementById('btnSave').addEventListener('click', saveText);

      // å°ä¼˜åŒ–ï¼šé¡µé¢éšè—æ—¶ä¸è‡ªåŠ¨é‡è¿ï¼Œè¿”å›æ—¶å†ç»­
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          autoRestart = false; if (recognizing) recognition.stop();
        } else {
          autoRestart = document.getElementById('autorestart').checked;
        }
      });
    }
  </script>
</body>
</html>
